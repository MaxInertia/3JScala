<html>
    <head>
        <title>CCM Options</title>
        <meta charset="utf-8">

        <!-- styles for the first page -->
        <!--<link rel="stylesheet" href="css/optionWindowStyle.css">-->

        <!-- jQuery library -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

        <!-- Source of the three links below: https://getbootstrap.com/docs/4.0/getting-started/introduction/ -->

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
        integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    </head>
    <body>
        <h1 style="text-align: center;padding-top: 50px;">VR Data Visualization</h1>
        <br><br><br>

        <!-- Time Series Input with Options -->
        <div class="row">
            <div class="col-sm-1"></div>

            <!-- Time Series 1 -->
            <div class="col-sm-4 well">
                <h3 style="text-align:center;">Dataset 1</h3><br>
                <input type="file" id="SM1_timeSeries" onchange="fileInputChanged(this)" style="padding-left: 30px;"/><br>
            </div>
            <div class="col-sm-2"></div>

            <!-- Time Series 2 -->
            <div class="col-sm-4 well">
                <h3 style="text-align:center;">Dataset 2 (Optional)</h3><br>
                <input type="file" id="SM2_timeSeries" onchange="fileInputChanged(this)" style="padding-left: 30px;"/><br>
            </div>

            <div class="col-sm-1"></div>
        </div>

        <!-- Apply options - Loads scene if inputs are valid -->
        <div class="row" style="text-align: center">
            <button style="position: center" onclick="validateForm()">Apply configuration</button>
        </div>
        <br><br><br>

        <!-- Credits footer -->
        <footer class="footer">
            <div class="container">
                <br>
                <span>
                    <p id=welc2 style="text-align:center;">A Tool developed for 3D Visualization of Datasets</p>
                    <p class="welbody" style="text-align:center;">by Cephil Lab @ Usask</p>
                </span>
            </div>
        </footer>

        <script type="text/JavaScript">

            var fileCount = 0;
            var filesLoaded = 0;
            var file1set = false;
            var file2set = false;

            function fileInputChanged(input) {
                console.log("File input changed for: " + input.id);
                if(input.id == "SM1_timeSeries") {
                    file1set = true;
                } else if(input.id == "SM2_timeSeries") {
                    file2set = true;
                }
            }

            function validateForm() {
                //var regexp1 = new RegExp("[^1-99]");
                //var tau1 = $("#SM1_tau").val();
                //var tau2 = $("#SM2_tau").val();
                var success = true;

                /*if(file1set && (regexp1.test(tau1) || tau1 == "")) {
                    alert("Tau for Time Series 1 is invalid: Must be an integer between 1 and 99");
                    success = false;
                } else */
                if(!file1set) {
                    /*localStorage.removeItem("SM1_tau");
                    localStorage.removeItem("SM1_firstDiff");
                    localStorage.removeItem("SM1_standardize");*/
                    localStorage.removeItem("SM1_timeSeries");
                }

                /*if(file2set && (regexp1.test(tau2) || tau2 == "")) {
                    alert("Tau for Time Series 2 is invalid: Must be an integer between 1 and 99");
                    success = false;
                } else */
                if(!file2set) {
                    /*localStorage.removeItem("SM2_tau");
                    localStorage.removeItem("SM2_firstDiff");
                    localStorage.removeItem("SM2_standardize");*/
                    localStorage.removeItem("SM2_timeSeries");
                }

                if(!success) { return false; }

                // Storing options in local browser storage

                //var firstDiff1 = $("#SM1_firstDiff");
                //var standardize1 = $("#SM1_standardize");

                if(file1set) {
                    fileCount++;
                    /*console.log("SM1_tau: " + document.getElementById("SM1_tau").value);
                    console.log("SM1_firstDiff: " + firstDiff1.prop('checked'));
                    console.log("SM1_standardize: " + standardize1.prop('checked'));
                    console.log("Adding file1 to browser storage.");
                    localStorage.setItem("SM1_tau", tau1);
                    localStorage.setItem("SM1_firstDiff", firstDiff1.prop('checked'));
                    localStorage.setItem("SM1_standardize", standardize1.prop('checked'));*/
                }

                //var firstDiff2 = $("#SM2_firstDiff");
                //var standardize2 = $("#SM2_standardize");

                if(file2set) {
                    fileCount++;
                    /*console.log("Adding file2 to browser storage.");
                    console.log("SM2_tau: " + document.getElementById("SM2_tau").value);
                    console.log("SM2_firstDiff: " +  firstDiff2.prop('checked'));
                    console.log("SM2_standardize: " +  standardize2.prop('checked'));
                    localStorage.setItem("SM2_tau", tau2);
                    localStorage.setItem("SM2_firstDiff", firstDiff2.prop('checked'));
                    localStorage.setItem("SM2_standardize", standardize2.prop('checked'));*/
                }

                loadTimeSeries();
            }

            function loadTimeSeries() {

                function loadCSV(fileInput) {
                    var csv = document.getElementById(fileInput);
                    console.log("File: "+csv.files[0]);

                    var reader = new FileReader();
                    // Other reader event handlers: onabort, onerror, onloadstart, onloadend, onprogress
                    reader.onload = function(e) {
                        //console.log("reader.result: \n"+ reader.result);

                        // Storing dataset in local browser storage
                        localStorage.setItem("SM"+ (filesLoaded + 1) +"_timeSeries", reader.result);

                        // Switch to VR if we've loaded in all files
                        if(filesLoaded === (fileCount-1)) {
                            window.location.href='vr';
                        } else {
                            filesLoaded = filesLoaded + 1;
                        }
                    };

                    reader.readAsText(csv.files[0], 'UTF-8');
                }

                localStorage.setItem("showSamples", "false");
                if(file1set) loadCSV("SM1_timeSeries");
                if(file2set) loadCSV("SM2_timeSeries");
            }

        </script>

    </body>
</html>
